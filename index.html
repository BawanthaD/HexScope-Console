<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Device Console</title>
  <style>
    :root {
      --bg-body: #020617;
      --bg-surface: #0f172a;
      --border-subtle: rgba(148, 163, 184, 0.16);
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.1);
      --danger: #ef4444;
      --text-primary: #e5e7eb;
      --text-muted: #94a3b8;
      --radius-lg: 12px;
      --radius-sm: 6px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.65);
      --input-bg: #020617;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #0b1120 0, #020617 40%, #020617 100%);
      color: var(--text-primary);
    }

    /* Header --------------------------------------------- */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.88);
      border-bottom: 1px solid var(--border-subtle);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-logo {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #1d4ed8 60%, #020617 90%);
      box-shadow: 0 0 18px rgba(59, 130, 246, 0.7);
      margin-right: 10px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
    }

    .app-title {
      font-size: 1.15rem;
      font-weight: 600;
    }

    .topbar-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
    }

    .status-dot.connected {
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
    }

    .btn-primary:hover { background: #2563eb; }

    .btn-outline {
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-primary);
    }

    .btn-danger {
      background: #b91c1c;
      color: white;
    }

    /* Layout --------------------------------------------- */
    .page {
      padding: 18px 24px;
      max-width: 1400px;
      margin: auto;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.4fr 2fr;
      gap: 20px;
    }

    .panel {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      padding: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      position: relative;
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .panel-caption {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    select, input[type="number"] {
      background: var(--input-bg);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      outline: none;
    }

    textarea {
      width: 100%;
      height: 200px;
      background: var(--input-bg);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 8px;
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: 0.8rem;
    }

    .latest-value-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.08);
    }

    canvas {
      background: #020617;
      border-radius: 10px;
    }

    .checkbox-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 999px;
      margin-right: 6px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="app-logo"></div>
      <div>
        <div class="app-title">Device Console</div>
        <div class="topbar-subtitle">Hex protocol · Serial monitor · Plotting · Logging</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:12px;">
      <div class="status-pill">
        <span id="statusDot" class="status-dot"></span>
        <span id="statusText"><strong>Disconnected</strong></span>
      </div>

      <label>Baud</label>
      <select id="baudRate">
        <option value="115200" selected>115200</option>
        <option value="57600">57600</option>
        <option value="38400">38400</option>
      </select>

      <button id="connectBtn" class="btn btn-primary">Connect</button>
      <button id="disconnectBtn" class="btn btn-outline btn-danger" disabled>Disconnect</button>
    </div>
  </header>


  <!-- MAIN -->
  <main class="page">
    <div class="grid">
      
      <!-- LEFT COLUMN -->
      <div style="display:flex; flex-direction:column; gap:20px;">
        
        <!-- VARIABLES PANEL -->
        <div class="panel">
          <div class="panel-title">Variables</div>
          <div class="panel-caption">Select a variable and interact with the device</div>

          <label>Variable</label><br>
          <select id="varSelect"></select>
          <br><br>

          <button id="readVarBtn" class="btn btn-outline" disabled>Read</button>
          <br><br>

          <label>Write value</label><br>
          <input id="writeValue" type="number" style="width:120px;">
          <button id="writeVarBtn" class="btn btn-outline" disabled>Write</button>
          <br><br>

          <button id="notifyStartBtn" class="btn btn-primary" disabled>Start Notify</button>
          <button id="notifyStopBtn" class="btn btn-outline" disabled>Stop Notify</button>
        </div>

        <!-- RESET / TOOLS PANEL -->
        <div class="panel">
            <div class="panel-title">Tools</div>
            <div class="panel-caption">Reset logs, values, and chart</div>

            <button id="clearRxBtn2" class="btn btn-outline" style="width:100%; margin-bottom:8px;">
                Clear Raw RX Log
            </button>

            <button id="clearValueLogBtn" class="btn btn-outline" style="width:100%; margin-bottom:8px;">
                Clear Value Log
            </button>

            <button id="clearChartBtn" class="btn btn-outline" style="width:100%; margin-bottom:8px;">
                Reset Chart
            </button>

            <button id="clearLatestBtn" class="btn btn-outline" style="width:100%;">
                Clear Latest Values
            </button>
        </div>


        <!-- LATEST VALUES PANEL -->
        <div class="panel">
          <div class="panel-title">Latest Values</div>
          <div class="panel-caption">Automatically updates when data arrives</div>
          <div id="latestValuesContainer"></div>
        </div>

      </div>


      <!-- RIGHT COLUMN -->
      <div style="display:flex; flex-direction:column; gap:20px;">

        <!-- PLOT PANEL -->
        <div class="panel">
          <div class="panel-title">Live Plot</div>
          <div class="panel-caption">One dataset per variable</div>

          <div id="plotVarContainer" style="margin-bottom:10px;"></div>

          <canvas id="dataChart" height="240"></canvas>

          <button id="downloadLogBtn" class="btn btn-outline" style="margin-top:8px;">
            Download Log (.txt)
          </button>
          <span id="logInfo" style="font-size:0.78rem; color:var(--text-muted); margin-left:6px;"></span>
        </div>


        <!-- RAW HEX PANEL -->
        <div class="panel">
          <div class="panel-title">Raw RX (Hex)</div>
          <div class="panel-caption">Raw bytes received from UART</div>

          <textarea id="rxLog" readonly></textarea>
          <button id="clearRxBtn" class="btn btn-outline" style="margin-top:8px;">Clear</button>
        </div>

      </div>

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /* ========== LOAD VARIABLES.JSON ========== */

    let VARIABLE_DB = [];

    async function loadVariableDb() {
      try {
        const res = await fetch('variables.json');
        VARIABLE_DB = await res.json();

        initVariableDropdowns();
        initLatestValuesUI();
        initChartDatasets();

      } catch (e) {
        alert("Failed to load variables.json");
        console.error(e);
      }
    }

    loadVariableDb();


    /* ========== UI ELEMENTS ========== */

    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const varSelect = document.getElementById("varSelect");
    const rxLog = document.getElementById("rxLog");

    const readVarBtn = document.getElementById("readVarBtn");
    const writeVarBtn = document.getElementById("writeVarBtn");
    const notifyStartBtn = document.getElementById("notifyStartBtn");
    const notifyStopBtn = document.getElementById("notifyStopBtn");
    const writeValueInput = document.getElementById("writeValue");

    const plotVarContainer = document.getElementById("plotVarContainer");
    const latestValuesContainer = document.getElementById("latestValuesContainer");


    /* ========== PROTOCOL CONSTANTS ========== */

    const SOF = 0xAA;
    const EOF = 0x55;

    const CMD_READ_VAR = 0x01;
    const CMD_WRITE_VAR = 0x02;
    const CMD_NOTIFY_START = 0x03;
    const CMD_NOTIFY_STOP = 0x04;

    const CMD_READ_RESPONSE = 0x81;
    const CMD_NOTIFY_DATA = 0x82;


    /* ========== SERIAL HANDLING ========== */

    let port = null;
    let keepReading = false;
    let reader = null;

    async function connectSerial() {
      port = await navigator.serial.requestPort();
      const baud = parseInt(document.getElementById("baudRate").value);

      await port.open({ baudRate: baud });

      statusDot.classList.add("connected");
      statusText.innerHTML = `<strong>Connected</strong> (${baud})`;

      readVarBtn.disabled = writeVarBtn.disabled =
      notifyStartBtn.disabled = notifyStopBtn.disabled = false;

      keepReading = true;
      readLoop();
    }

    async function readLoop() {
      reader = port.readable.getReader();
      try {
        while (keepReading) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) handleIncomingBytes(value);
        }
      } catch (err) {
        console.error(err);
      } finally {
        reader.releaseLock();
      }
    }

    async function disconnectSerial() {
      keepReading = false;
      if (reader) reader.cancel();
      if (port) await port.close();

      statusDot.classList.remove("connected");
      statusText.innerHTML = `<strong>Disconnected</strong>`;

      readVarBtn.disabled = writeVarBtn.disabled =
      notifyStartBtn.disabled = notifyStopBtn.disabled = true;
    }


    document.getElementById("connectBtn").addEventListener("click", connectSerial);
    document.getElementById("disconnectBtn").addEventListener("click", disconnectSerial);
    document.getElementById("clearRxBtn").addEventListener("click", () => rxLog.value = "");


    /* ========== SEND COMMANDS ========== */

    function crcXor(frame, start, end) {
      let crc = 0;
      for (let i = start; i <= end; i++) crc ^= frame[i];
      return crc & 0xff;
    }

    function buildFrame(type, payload) {
      const len = 1 + payload.length;    // TYPE + PAYLOAD
      const frame = new Uint8Array(1 + 1 + len + 1 + 1);

      let i = 0;
      frame[i++] = SOF;
      frame[i++] = len;
      frame[i++] = type;
      payload.forEach(b => frame[i++] = b);
      frame[i++] = crcXor(frame, 1, i - 1);
      frame[i++] = EOF;

      return frame;
    }

    async function sendFrame(frame) {
      const writer = port.writable.getWriter();
      await writer.write(frame);
      writer.releaseLock();
    }

    readVarBtn.onclick = async () => {
      const v = getSelectedVar();
      sendFrame(buildFrame(CMD_READ_VAR, [v.id]));
    };

    writeVarBtn.onclick = async () => {
      const v = getSelectedVar();
      const val = parseInt(writeValueInput.value);
      const lo = val & 0xff;
      const hi = (val >> 8) & 0xff;
      sendFrame(buildFrame(CMD_WRITE_VAR, [v.id, lo, hi]));
    };

    notifyStartBtn.onclick = () => {
      sendFrame(buildFrame(CMD_NOTIFY_START, [getSelectedVar().id]));
    };

    notifyStopBtn.onclick = () => {
      sendFrame(buildFrame(CMD_NOTIFY_STOP, [getSelectedVar().id]));
    };


    /* ========== PARSE INCOMING BYTES ========== */

    let rxBuffer = [];

    function handleIncomingBytes(chunk) {
      chunk.forEach(b => rxBuffer.push(b));

      rxLog.value += [...chunk].map(b => b.toString(16).padStart(2,"0")).join(" ") + "\n";
      rxLog.scrollTop = rxLog.scrollHeight;

      parseFrames();
    }

    function parseFrames() {
      while (rxBuffer.length >= 5) {
        if (rxBuffer[0] !== SOF) { rxBuffer.shift(); continue; }

        const len = rxBuffer[1];
        const frameLength = 1 + 1 + len + 1 + 1;

        if (rxBuffer.length < frameLength) return;

        const frame = rxBuffer.slice(0, frameLength);
        rxBuffer = rxBuffer.slice(frameLength);

        if (frame[frameLength - 1] !== EOF) continue;

        const crc = frame[frameLength - 2];
        const calc = crcXor(frame, 1, frameLength - 3);
        if (crc !== calc) continue;

        const type = frame[2];
        const payload = frame.slice(3, frameLength - 2);

        interpretFrame(type, payload);
      }
    }


    /* ========== FRAME INTERPRETATION ========== */

    const latestValues = new Map();
    const valueLog = [];

    function interpretFrame(type, payload) {
      if (payload.length < 1) return;

      if (type === CMD_READ_RESPONSE || type === CMD_NOTIFY_DATA) {
        const varId = payload[0];
        const lo = payload[1];
        const hi = payload[2];

        let value = (hi << 8) | lo;
        if (value & 0x8000) value = value - 65536;

        const v = VARIABLE_DB.find(x => x.id === varId);
        if (!v) return;

        // Update latest values
        latestValues.set(varId, value);
        const el = document.getElementById(`latest-${varId}`);
        if (el) el.textContent = value + " " + (v.unit || "");

        // Log value
        valueLog.push({
          time: new Date().toISOString(),
          varId,
          name: v.name,
          value,
          unit: v.unit
        });
        document.getElementById("logInfo").textContent = valueLog.length + " samples";

        addChartPoint(varId, value);
      }
    }


    /* ========== VARIABLE DROPDOWN & UI INIT ========== */

    function initVariableDropdowns() {
      VARIABLE_DB.forEach(v => {
        varSelect.innerHTML += `<option value="${v.id}">
          ${v.name} (0x${v.id.toString(16)})
        </option>`;
      });
    }

    function initLatestValuesUI() {
      latestValuesContainer.innerHTML = "";
      VARIABLE_DB.forEach(v => {
        latestValuesContainer.innerHTML += `
          <div class="latest-value-row">
            <div><strong>${v.name}</strong> <span style="color:#94a3b8">(0x${v.id.toString(16)})</span></div>
            <div id="latest-${v.id}" style="color:#94a3b8">—</div>
          </div>`;
      });
    }

    function getSelectedVar() {
      const id = parseInt(varSelect.value);
      return VARIABLE_DB.find(v => v.id === id);
    }


    /* ========== CHART ========== */

    const chartCtx = document.getElementById("dataChart").getContext("2d");
    const datasets = [];
    const MAX_POINTS = 300;
    const t0 = performance.now();

    const dataChart = new Chart(chartCtx, {
      type: 'line',
      data: { datasets },
      options: {
        animation: false,
        scales: {
          x: { type: 'linear', title: { display: true, text: 'Time (s)' }},
          y: { title: { display: true, text: "Value" }}
        }
      }
    });

    function initChartDatasets() {
      VARIABLE_DB.forEach((v, idx) => {
        datasets.push({
          label: v.name,
          varId: v.id,
          data: [],
          borderColor: getColor(idx),
          borderWidth: 1.5,
          pointRadius: 0,
          hidden: idx !== 0,
          parsing: false
        });

        plotVarContainer.innerHTML += `
          <label class="checkbox-pill">
            <input type="checkbox" data-id="${v.id}" ${idx===0?"checked":""}>
            ${v.name}
          </label>
        `;
      });

      plotVarContainer.querySelectorAll("input").forEach(cb => {
        cb.onchange = () => {
          const varId = parseInt(cb.dataset.id);
          const ds = datasets.find(d => d.varId === varId);
          ds.hidden = !cb.checked;
          dataChart.update();
        };
      });
    }

    function addChartPoint(varId, value) {
      const t = (performance.now() - t0) / 1000;
      const ds = datasets.find(d => d.varId === varId);
      if (!ds) return;

      ds.data.push({ x: t, y: value });
      if (ds.data.length > MAX_POINTS) ds.data.shift();
      dataChart.update('none');
    }

    function getColor(i) {
      const palette = ["#3b82f6","#22c55e","#ef4444","#eab308","#a855f7","#14b8a6"];
      return palette[i % palette.length];
    }


    /* ========== LOG DOWNLOAD ========== */

    document.getElementById("downloadLogBtn").onclick = () => {
      if (!valueLog.length) return alert("No data yet");

      let text = "time,varId,name,value,unit\n";
      valueLog.forEach(s => {
        text += `${s.time},0x${s.varId.toString(16)},${s.name},${s.value},${s.unit}\n`;
      });

      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "values_log.txt";
      a.click();
      URL.revokeObjectURL(url);
    };

    /* ========== RESET BUTTON HANDLERS ========== */

    document.getElementById("clearRxBtn2").onclick = () => {
    rxLog.value = "";
    rxBuffer = [];
    };

    document.getElementById("clearValueLogBtn").onclick = () => {
    valueLog.length = 0;
    document.getElementById("logInfo").textContent = "0 samples";
    };

    document.getElementById("clearChartBtn").onclick = () => {
    datasets.forEach(ds => ds.data = []);
    dataChart.update();
    };

    document.getElementById("clearLatestBtn").onclick = () => {
    latestValues.forEach((_, varId) => {
        latestValues.set(varId, null);
        const el = document.getElementById(`latest-${varId}`);
        if (el) el.textContent = "—";
    });
    };


  </script>

</body>
</html>
